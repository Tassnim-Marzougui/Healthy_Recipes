@* Chat partial: floating FAB + bubble chat UI with typing animation and green branding *@
<link rel="stylesheet" href="/css/chatbot.css" />

<div id="hr-chat-fab" class="hr-chat-fab" title="Ouvrir le chat">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3C7.03 3 3 6.58 3 11C3 12.85 3.7 14.56 4.9 15.99V21L9.2 18.83C10.02 19.09 10.99 19.25 12 19.25C16.97 19.25 21 15.67 21 11.25C21 6.83 16.97 3 12 3Z" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <div class="hr-chat-badge" style="display:none">1</div>
</div>

<div id="hr-chat-panel" class="hr-chat-panel" style="display:none" aria-hidden="true">
    <div class="hr-chat-header">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 3C7.03 3 3 6.58 3 11C3 12.85 3.7 14.56 4.9 15.99V21L9.2 18.83C10.02 19.09 10.99 19.25 12 19.25C16.97 19.25 21 15.67 21 11.25C21 6.83 16.97 3 12 3Z" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <h4>Healthy Recipes — Assistant</h4>
        <div class="hr-chat-close" id="hr-chat-close" title="Fermer">✕</div>
    </div>

    <div class="hr-chat-body" id="hr-chat-body" role="log" aria-live="polite"></div>

    <div class="hr-chat-input">
        <textarea id="hr-chat-input" placeholder="Écris ton message..." rows="2"></textarea>
        <button id="hr-chat-send">Envoyer</button>
    </div>
</div>

<script>
(() => {
    const fab = document.getElementById('hr-chat-fab');
    const panel = document.getElementById('hr-chat-panel');
    const closeBtn = document.getElementById('hr-chat-close');
    const bodyEl = document.getElementById('hr-chat-body');
    const input = document.getElementById('hr-chat-input');
    const send = document.getElementById('hr-chat-send');
    let contextId = null;

    function openPanel(){ panel.style.display='flex'; panel.setAttribute('aria-hidden','false'); input.focus(); }
    function closePanel(){ panel.style.display='none'; panel.setAttribute('aria-hidden','true'); }

    fab.addEventListener('click', ()=>{
        if(panel.style.display==='flex') closePanel(); else openPanel();
    });
    closeBtn.addEventListener('click', closePanel);

    function autoScroll(){ bodyEl.scrollTop = bodyEl.scrollHeight; }

    function appendMessage(role, text, options={typing:false}){
        const wrap = document.createElement('div');
        wrap.className = 'hr-message ' + (role==='user' ? 'user' : 'bot');
        const bubble = document.createElement('div');
        bubble.className = 'hr-bubble ' + (role==='user' ? 'user' : 'bot');
        if(options.typing){
            bubble.innerHTML = `<span class="hr-typing"><span class="hr-dots"><span></span><span></span><span></span></span></span>`;
        } else {
            bubble.innerHTML = text;
        }
        wrap.appendChild(bubble);
        bodyEl.appendChild(wrap);
        autoScroll();
        return bubble;
    }

    async function sendMessage(weekly){
        const txt = input.value && input.value.trim();
        if(!txt) return;
        appendMessage('user', txt);
        input.value='';

        const typingBubble = appendMessage('bot', '', {typing:true});

        try{
            const res = await fetch('/api/Chat', { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ message: txt, contextId: contextId, weekly: !!weekly }) });
            if(!res.ok){
                const err = await res.text();
                typingBubble.innerHTML = 'Erreur: '+err;
                return;
            }
            const data = await res.json();
            if(data.contextId) contextId = data.contextId;
            // replace typing with actual reply
            typingBubble.innerHTML = data.reply || 'Aucune réponse';

            if(data.suggestions && data.suggestions.length){
                const list = document.createElement('div');
                list.style.marginTop='8px';
                list.innerHTML = '<strong>Suggestions:</strong><ul style="margin:6px 0;padding-left:18px">' + data.suggestions.map(s=>`<li>${s.title} — ${s.calories} kcal — ${s.prep} min</li>`).join('') + '</ul>';
                bodyEl.appendChild(list);
            }

            if(data.weekly && data.days){
                const pre = document.createElement('pre');
                pre.style.background='#fff'; pre.style.padding='8px'; pre.style.borderRadius='6px'; pre.textContent = JSON.stringify(data.days, null, 2);
                bodyEl.appendChild(pre);
            }

        }catch(err){
            typingBubble.innerHTML = 'Erreur réseau.';
            console.error(err);
        } finally{ autoScroll(); }
    }

    send.addEventListener('click', ()=> sendMessage(false));
    input.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(false); } });
})();
</script>
